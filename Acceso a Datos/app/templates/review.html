{% extends 'base.html' %}

{% block body %}

<div class="acnh-bg">
    <div class="container py-4" style="height: 100vh;"> <div class="row h-100">
            
            <div class="col-md-4 col-lg-3 h-100 d-flex flex-column">
                <div class="search-box p-3 mb-3">
                    <h5 class="fw-bold text-brown"><i class="fa-solid fa-users"></i> Neighbors</h5>
                    <input type="text" id="searchInput" class="form-control acnh-input" placeholder="Search name...">
                </div>

                <div class="villager-list-container custom-scroll">
                    {% for villager in villagers|dictsort:"name" %}
                    <div class="villager-list-item" 
                         onclick="loadPassport('{{ villager.id }}', '{{ villager.name }}', '{{ villager.iconUrl }}', '{{ villager.species }}', '{{ villager.personality }}')">
                        
                        <div class="d-flex align-items-center">
                            <img src="{{ villager.iconUrl }}" class="list-icon" alt="icon">
                            <div class="ms-2">
                                <div class="fw-bold text-brown">{{ villager.name }}</div>
                                <small class="text-muted review-status" id="status-list-{{ villager.id }}">
                                    Tap to review
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="col-md-8 col-lg-9 h-100 d-flex align-items-center justify-content-center">
                
                <div class="passport-card fade-in" id="passportCard" style="display: none;">
                    
                    <div class="passport-header">
                        <div class="passport-photo-frame">
                            <img id="passImg" src="" alt="Villager">
                        </div>
                        <div class="passport-info">
                            <h2 id="passName" class="display-6 fw-bold text-brown mb-0">Name</h2>
                            <span class="badge bg-acnh me-1" id="passSpecies">Species</span>
                            <span class="badge bg-secondary" id="passPersonality">Personality</span>
                        </div>
                    </div>

                    <div class="passport-body mt-4">
                        <div class="text-center mb-3">
                            <label class="text-muted fw-bold small">CITIZEN RATING</label>
                            <div class="star-rating-big">
                                <i class="fa-solid fa-star star-btn" data-val="1"></i>
                                <i class="fa-solid fa-star star-btn" data-val="2"></i>
                                <i class="fa-solid fa-star star-btn" data-val="3"></i>
                                <i class="fa-solid fa-star star-btn" data-val="4"></i>
                                <i class="fa-solid fa-star star-btn" data-val="5"></i>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="text-muted fw-bold small">REGISTRATION NOTES</label>
                            <textarea id="passComment" class="form-control acnh-textarea" rows="4" placeholder="Write your official report here..."></textarea>
                        </div>

                        <input type="hidden" id="currentVillagerId">

                        <button onclick="savePassport()" class="btn btn-acnh w-100 py-2">
                            <i class="fa-solid fa-stamp"></i> Update Passport
                        </button>
                    </div>
                </div>

                <div class="text-center text-muted opacity-50" id="emptyState">
                    <i class="fa-solid fa-id-card fa-5x mb-3"></i>
                    <h3>Select a neighbor from the list<br>to view their file.</h3>
                </div>

            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    .acnh-bg {
        background-color: #79D5B1; /* Verde menta tipo NookPhone */
        background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.1) 0, rgba(255,255,255,0.1) 20px, transparent 20px, transparent 40px);
        min-height: 100vh;
        overflow: hidden; /* Importante para el layout de app */
        font-family: 'Varela Round', sans-serif;
    }
    
    .text-brown { color: #584C3F; }

    /* LISTA IZQUIERDA */
    .search-box {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .acnh-input {
        border-radius: 20px;
        border: 2px solid #ddd;
        background: #f9f9f9;
    }

    .villager-list-container {
        flex-grow: 1;
        overflow-y: auto;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 20px;
        padding: 10px;
        /* Scrollbar bonita */
        scrollbar-width: thin;
        scrollbar-color: #584C3F transparent;
    }
    
    .villager-list-item {
        background: white;
        margin-bottom: 8px;
        padding: 10px;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
    }
    .villager-list-item:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    .villager-list-item.active {
        border-color: #F4D35E;
        background-color: #fffdf0;
    }

    .list-icon { width: 45px; height: 45px; object-fit: contain; }

    /* PASAPORTE DERECHA */
    .passport-card {
        background: #FDFDFD; /* Color papel */
        width: 100%;
        max-width: 500px;
        border-radius: 30px;
        padding: 30px;
        box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        border: 8px solid white; /* Borde doble */
        position: relative;
    }
    /* Estilo hoja de pasaporte */
    .passport-card::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; height: 15px;
        background: #61A667; /* Franja verde arriba */
        border-radius: 20px 20px 0 0;
    }

    .passport-header { display: flex; align-items: center; gap: 20px; margin-top: 10px; }
    
    .passport-photo-frame {
        width: 100px; height: 100px;
        background: #E8F3F1;
        border-radius: 20px;
        display: flex; align-items: center; justify-content: center;
        border: 2px dashed #ccc;
    }
    .passport-photo-frame img { width: 80%; height: 80%; object-fit: contain; }

    .acnh-textarea {
        background: #F0F0F0;
        border: none;
        border-radius: 15px;
        padding: 15px;
    }
    
    .star-rating-big { font-size: 2.5rem; color: #eee; cursor: pointer; }
    .star-btn.active { color: #F4D35E; filter: drop-shadow(0 2px 0 rgba(0,0,0,0.1)); }
    .star-btn:hover { color: #ffe066; }

    .bg-acnh { background-color: #61A667; }
    
    .btn-acnh {
        background-color: #F4D35E;
        color: #584C3F;
        font-weight: 800;
        border-radius: 25px;
        border: 2px solid white;
        box-shadow: 0 4px 0 rgba(200, 170, 50, 0.5);
        transition: transform 0.1s;
    }
    .btn-acnh:active {
        transform: translateY(4px);
        box-shadow: none;
    }

    /* Animación simple */
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

</style>

<script>
    const existingReviews = {{ reviews_json|safe }};
    let currentRating = 0;


    document.addEventListener("DOMContentLoaded", () => {
        for (const [id, data] of Object.entries(existingReviews)) {
            const statusLabel = document.getElementById(`status-list-${id}`);
            if (statusLabel) {
                statusLabel.innerHTML = `<span class="text-success fw-bold"><i class="fa-solid fa-check"></i> ${data.rating}/5 Stars</span>`;
            }
        }
    });

    // Filtro de búsqueda
    document.getElementById('searchInput').addEventListener('keyup', function() {
        let filter = this.value.toLowerCase();
        let items = document.querySelectorAll('.villager-list-item');
        items.forEach(item => {
            let text = item.innerText.toLowerCase();
            item.style.display = text.includes(filter) ? "" : "none";
        });
    });

    // Cargar pasaporte
    function loadPassport(id, name, imgUrl, species, personality) {
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('passportCard').style.display = 'block';

        // seleccionado
        document.querySelectorAll('.villager-list-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');

        // Rellenar datos
        document.getElementById('passName').innerText = name;
        document.getElementById('passImg').src = imgUrl;
        document.getElementById('passSpecies').innerText = species || 'Unknown';
        document.getElementById('passPersonality').innerText = personality || 'Unknown';
        document.getElementById('currentVillagerId').value = id;

        // Resetear inputs
        currentRating = 0;
        document.getElementById('passComment').value = '';
        updateStarsUI(0);

        // Si ya existe review, cargarla
        if (existingReviews[id]) {
            currentRating = existingReviews[id].rating;
            document.getElementById('passComment').value = existingReviews[id].comment;
            updateStarsUI(currentRating);
        }
        

        const card = document.getElementById('passportCard');
        card.classList.remove('fade-in');
        void card.offsetWidth;
        card.classList.add('fade-in');
    }


    document.querySelectorAll('.star-btn').forEach(star => {
        star.addEventListener('click', function() {
            currentRating = parseInt(this.getAttribute('data-val'));
            updateStarsUI(currentRating);
        });
    });

    function updateStarsUI(rating) {
        document.querySelectorAll('.star-btn').forEach(s => {
            if (parseInt(s.getAttribute('data-val')) <= rating) {
                s.classList.add('active');
            } else {
                s.classList.remove('active');
            }
        });
    }

    // Guardar Review
    function savePassport() {
        const id = document.getElementById('currentVillagerId').value;
        const comment = document.getElementById('passComment').value;

        if (!id) return;
        if (currentRating === 0) {
            alert("Please stamp the stars first! (Select a rating)");
            return;
        }

        fetch("{% url 'save_review' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                villager_id: id,
                rating: currentRating,
                comment: comment
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'ok') {
                // Actualizar datos locales
                existingReviews[id] = { rating: currentRating, comment: comment };
                
                // Actualizar la lista
                document.getElementById(`status-list-${id}`).innerHTML = 
                    `<span class="text-success fw-bold"><i class="fa-solid fa-check"></i> ${currentRating}/5 Stars</span>`;
                
                // Guardado
                const btn = document.querySelector('.btn-acnh');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Saved!';
                btn.style.backgroundColor = '#61A667'; // Verde
                btn.style.color = 'white';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.backgroundColor = '#F4D35E';
                    btn.style.color = '#584C3F';
                }, 1500);

            } else {
                alert("Error saving passport.");
            }
        });
    }
</script>

{% endblock %}